function getQueryString(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),o=window.location.search.substr(1).match(t);return null!=o?decodeURIComponent(o[2]):null}function initAddressInfo(e,t){var o=document.getElementById("destname"),n=document.getElementById("destaddress");o.innerText=e,n.innerText=t}var lng,maskEle=document.getElementById("weui-mask"),actionsheetEle=document.getElementById("actionsheet"),routeactionEle=document.getElementById("routeaction"),firstGeolocation=!0,myPosition=null,lat=null,targetPosition=[],routeLine=null,drivingResult=null,destName="",destAddress="",zoom="";function showActions(){console.log("showactions"),maskEle.style.opacity=1,maskEle.style.display="block",actionsheetEle.classList.add("weui-actionsheet_toggle")}function hideActions(){actionsheetEle.classList.remove("weui-actionsheet_toggle"),maskEle.style.opacity=0,maskEle.style.display="none"}lng=getQueryString("longitude"),lat=getQueryString("latitude"),destName=getQueryString("name")||"",destAddress=getQueryString("address"),"number"!=typeof(zoom=parseInt(getQueryString("zoom"),10)||11)&&console.log("zoom格式必须是number类型"),targetPosition=null===lng||null===lat?(console.log("请在url参数中，同时传入经度lng和纬度lat参数。"),[116.397428,39.90923]):[lng=parseFloat(lng),lat=parseFloat(lat)],initAddressInfo(destName,destAddress);var map=new AMap.Map("container",{center:targetPosition,zoom:zoom}),endMarker=new AMap.Marker({icon:"https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png",position:targetPosition});map.add(endMarker);var scale=new AMap.Scale({visible:!0});map.addControl(scale),AMap.plugin("AMap.Geolocation",function(){var e=new AMap.Geolocation({enableHighAccuracy:!0,timeout:2e4,buttonPosition:"RB",buttonOffset:new AMap.Pixel(10,20),showMarker:!0,showCircle:!1,panToLocation:!1,zoomToAccuracy:!1});map.addControl(e),e.getCurrentPosition(),AMap.event.addListener(e,"complete",function(e){try{routeactionEle.style.display="block",console.log("定位成功",e);var t=e.position;!(myPosition=[t.lng,t.lat])===firstGeolocation?(map.panTo(myPosition),map.setFitView([myPosition,targetPosition])):(searchRoute(targetPosition,myPosition,function(){}),firstGeolocation=!1),console.log("执行完")}catch(e){console.log(e)}}),AMap.event.addListener(e,"error",function(e){console.log("定位失败",e)})});var drivingOption={policy:AMap.DrivingPolicy.LEAST_TIME,ferry:1},driving=new AMap.Driving(drivingOption),SHOWROUTETEXT="显示路线",HIDEROUTETEXT="隐藏路线";function routeAction(){hideActions(),routeactionEle.innerText===SHOWROUTETEXT?(showRoute(),routeactionEle.innerHTML=HIDEROUTETEXT):(hideRoute(),routeactionEle.innerText=SHOWROUTETEXT)}function searchRoute(e,t,o){driving.search(new AMap.LngLat(e[0],e[1]),new AMap.LngLat(t[0],t[1]),function(e,t){"complete"===e?(drivingResult=t).routes&&t.routes.length&&(null===routeLine&&drawRoute(t.routes[0]),o&&o()):log.error("获取数据失败："+t)})}function drawRoute(e){var t=parseRouteToPath(e);routeLine=new AMap.Polyline({path:t,isOutline:!0,outlineColor:"#ffeeee",borderWeight:2,strokeWeight:5,strokeColor:"#0091ff",lineJoin:"round"})}function showRoute(){routeLine&&map.add(routeLine)}function hideRoute(){routeLine&&map.remove(routeLine)}function parseRouteToPath(e){for(var t=[],o=0,n=e.steps.length;o<n;o++)for(var i=e.steps[o],a=0,r=i.path.length;a<r;a++)t.push(i.path[a]);return t}function drivingOnApp(){drivingResult?driving.searchOnAMAP({origin:{lng:myPosition[0],Q:myPosition[0],lat:myPosition[1],P:myPosition[1]},destination:{lng:targetPosition[0],Q:targetPosition[0],lat:targetPosition[1],P:targetPosition[1]}}):endMarker.markOnAMAP({name:destName,position:endMarker.getPosition()})}