<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">     
    <meta content="yes" name="apple-mobile-web-app-capable">     
    <meta content="black" name="apple-mobile-web-app-status-bar-style">     
    <meta content="telephone=no" name="format-detection">
    <title>地图</title>
    <link rel="stylesheet" href="https://a.amap.com/jsapi_demos/static/demo-center/css/demo-center.css" />
    <link rel="stylesheet" href="./openlocation.css?_=1" />
    <script type="text/javascript" src="./common/js/vconsole.js"></script>
    <script src="./fastclick.js"></script>
    <script src="https://webapi.amap.com/maps?v=1.4.14&key=4f7ad639338c4aeb8e020bfa8f5bce62&plugin=AMap.Driving,AMap.Scale"></script>
    <script src="https://a.amap.com/jsapi_demos/static/demo-center/js/demoutils.js"></script>
</head>
<body ontouchmove="event.preventDefault()">
<div class="common_center">
    <div class="map-all">
        <div id="container"></div>
    </div>
</div>
<div class="">
    <div id="weui-mask" class="weui-mask" style="display: none;"></div>
    <div id="actionsheet" class="weui-actionsheet">
        <div class="weui-actionsheet__menu">
            <div id="routeaction" style="display: none;" class="weui-actionsheet__cell" onclick="routeAction()">显示路线</div>
            <div class="weui-actionsheet__cell" onclick="drivingOnApp()">
              高德地图
            </div>
        </div>
        <div class="weui-actionsheet__action">
            <div id=“cancel” class="weui-actionsheet__cell" onclick="hideActions()">取消</div>
        </div>
    </div>
</div>
<div class="bt-container">
    <div class="weui-flex">
        <div class="weui-flex__item bt-container-text">
            <p id="destname" class="bt-container-text__name"></p >
            <span id="destaddress" class="bt-container-text__address ellipsis"></span>
        </div>
        <div class="flex-center bt-container-icon" onclick="showActions()">
            <svg class="icon" style="width: 38px; height: 38px;vertical-align: middle;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="551"><path d="M512 512m-416 0a416 416 0 1 0 832 0 416 416 0 1 0-832 0Z" fill="#AEECFF" p-id="552"></path><path d="M752 512L580.032 604.032 312 512 102.656 583.872A415.744 415.744 0 0 0 512 928a415.808 415.808 0 0 0 408.96-341.376L752 512z" fill="#01ADDB" p-id="553"></path><path d="M289.728 863.232L312 512 102.656 583.872a415.552 415.552 0 0 0 187.072 279.36zM767.616 839.744L752 512 581.248 604.032l-8.768 319.104a412.864 412.864 0 0 0 195.136-83.392z" fill="#009BC4" p-id="554"></path><path d="M759.488 40c-105.984 0-192 85.952-192 192s192 358.016 192 358.016 192-251.968 192-358.016-86.016-192-192-192z m0 254.144a68.48 68.48 0 1 1 0-136.96 68.48 68.48 0 0 1 0 136.96z" fill="#38A4FE" p-id="555"></path><path d="M759.488 603.2l-6.4-8.32c-7.872-10.368-193.6-255.36-193.6-362.88C559.488 121.728 649.216 32 759.488 32s200 89.728 200 200c0 107.52-185.728 352.512-193.6 362.88l-6.4 8.32z m0-555.2a184.256 184.256 0 0 0-184 184c0 91.392 150.848 299.968 184 344.64 33.152-44.672 184-253.248 184-344.64A184.256 184.256 0 0 0 759.488 48z m0 254.144c-42.176 0-76.48-34.304-76.48-76.48s34.304-76.48 76.48-76.48 76.48 34.304 76.48 76.48-34.304 76.48-76.48 76.48z m0-137.024a60.544 60.544 0 0 0 0 120.96 60.544 60.544 0 0 0 0-120.96z" fill="#FFFFFF" p-id="556"></path><path d="M102.528 582.976c4.352 25.536 11.136 50.176 19.968 73.92l187.52-59.328 270.4 75.264 0.896-68.864L312 512 102.528 582.976z" fill="#429E2F" p-id="557"></path><path d="M897.408 668.096l-138.432-26.752-185.024 89.024-276.8-42.24-142.912 35.328c6.144 10.368 12.608 20.416 19.584 30.208l122.816-32.256 275.328 41.984 188.992-88 122.368 23.36c5.12-9.984 9.856-20.096 14.08-30.656z" fill="#FFFFFF" p-id="558"></path><path d="M415.232 916.224c6.464 1.472 12.864 3.072 19.456 4.288l8-360.128-18.688-6.848-8.768 362.688z" fill="#FFFFFF" p-id="559"></path><path d="M760.256 662.016m-40 0a40 40 0 1 0 80 0 40 40 0 1 0-80 0Z" fill="#FC354D" p-id="560"></path><path d="M825.088 785.344c8.896-10.112 17.216-20.672 25.088-31.616l-90.112-14.4-118.016 54.656 1.664 112.384c12.864-4.224 25.408-9.216 37.696-14.656l-1.344-77.76 84.032-36.032 60.992 7.424z" fill="#39BEE9" p-id="561"></path><path d="M817.984 540.736L832 655.36l65.408 12.736c10.752-26.56 18.688-54.528 23.808-83.52l-103.232-43.84z" fill="#F5F9C7" p-id="562"></path></svg>
        </div>
    </div>
</div>
<script type="text/javascript">
  // 获取url参数 
  function getQueryString(name) {
      var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
      var r = window.location.search.substr(1).match(reg);
      if (r != null) return decodeURIComponent(r[2]);
      return null;
  }
  // 初始化地址信息
  function initAddressInfo(name, address) {
    var destname = document.getElementById('destname');
    var destaddress = document.getElementById('destaddress');
    destname.innerText = name;
    destaddress.innerText = address;
  }
  var maskEle = document.getElementById('weui-mask');
  var actionsheetEle = document.getElementById('actionsheet');
  var routeactionEle = document.getElementById('routeaction');
  var firstGeolocation = true;
  var myPosition = null;
  var lng, lat = null;
  var targetPosition = [];
  var routeLine = null;
  var drivingResult = null;
  var destName = '';
  var destAddress = '';
  var zoom = '';

  lng = getQueryString('longitude');
  lat = getQueryString('latitude');
  destName = getQueryString('name') || '';
  destAddress = getQueryString('address');
  zoom = parseInt(getQueryString('zoom'), 10) || 11;
  if(typeof zoom !== 'number') {
    console.log('zoom格式必须是number类型');
  }

  if(lng === null || lat === null) {
    console.log('请在url参数中，同时传入经度lng和纬度lat参数。');
    // 默认定位到深圳
    targetPosition = [116.397428, 39.90923];
  } else {
    lng = parseFloat(lng);
    lat = parseFloat(lat);
    targetPosition = [lng, lat];
  }

  initAddressInfo(destName , destAddress);

    function showActions() {
      console.log('showactions');
      maskEle.style.opacity = 1;
      maskEle.style.display = 'block';
      // actionsheetEle.style.display = 'block';
      actionsheetEle.classList.add('weui-actionsheet_toggle');
    }
    function hideActions() {
      actionsheetEle.classList.remove('weui-actionsheet_toggle');
      maskEle.style.opacity = 0;
      maskEle.style.display = 'none';
      // actionsheetEle.style.display = 'none';
    }
    var map = new AMap.Map("container", {
      center: targetPosition,
      zoom: zoom
    });

    // 构造点标记
    var endMarker = new AMap.Marker({
      icon: "https://webapi.amap.com/theme/v1.3/markers/n/mark_b.png",
      position: targetPosition
    });
    map.add(endMarker);

    // 添加比例尺
    var scale = new AMap.Scale({
      visible: true
    });
    map.addControl(scale);

    // 定位功能
    AMap.plugin('AMap.Geolocation', function () {
      var geolocation = new AMap.Geolocation({
        enableHighAccuracy: true,//是否使用高精度定位，默认:true
        timeout: 20000,          //超过10秒后停止定位，默认：5s
        buttonPosition: 'RB',    //定位按钮的停靠位置
        buttonOffset: new AMap.Pixel(10, 20),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
        showMarker: true,        //定位成功后在定位到的位置显示点标记，默认：true
        showCircle: false,        //定位成功后用圆圈表示定位精度范围，默认：true
        panToLocation: false,     //定位成功后将定位到的位置作为地图中心点，默认：true
        zoomToAccuracy: false      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
      });
      map.addControl(geolocation);
      geolocation.getCurrentPosition();
      AMap.event.addListener(geolocation, 'complete', function (data) {
        try {
          routeactionEle.style.display = 'block';
          console.log('定位成功', data);
          var position = data.position;
          myPosition = [position.lng, position.lat]
          if (firstGeolocation === false) {
            map.panTo(myPosition);
            // 调整视野达到最佳显示区域
            map.setFitView([ myPosition, targetPosition ])
          } else {
            searchRoute(targetPosition, myPosition, function () {});
            firstGeolocation = false;
          }
          console.log('执行完')
        }catch(error) {
          console.log(error);
        }
      });//返回定位信息
      AMap.event.addListener(geolocation, 'error', function (data) {
        console.log('定位失败', data);
        // log.error('定位失败');
      });//返回定位出错信息
    });

    var drivingOption = {
      policy: AMap.DrivingPolicy.LEAST_TIME, // 其它policy参数请参考 https://lbs.amap.com/api/javascript-api/reference/route-search#m_DrivingPolicy
      ferry: 1 // 是否可以使用轮渡
    }
    // 构造路线导航类
    var driving = new AMap.Driving(drivingOption)

    var SHOWROUTETEXT = '显示路线';
    var HIDEROUTETEXT = '隐藏路线'
    function routeAction() {
      hideActions();
      var text = routeactionEle.innerText;
      if (text === SHOWROUTETEXT) {
         showRoute();
        routeactionEle.innerHTML = HIDEROUTETEXT;
      } else {
        hideRoute();
        routeactionEle.innerText = SHOWROUTETEXT;
      }
    }

    function searchRoute(targetPosition, myPosition, callback) {
      // 根据起终点经纬度规划驾车导航路线
      driving.search(new AMap.LngLat(targetPosition[0], targetPosition[1]), new AMap.LngLat(myPosition[0], myPosition[1]), function (status, result) {
        // result即是对应的驾车导航信息，相关数据结构文档请参考 https://lbs.amap.com/api/javascript-api/reference/route-search#m_DrivingResult
        if (status === 'complete') {
          drivingResult = result;
          
          if (result.routes && result.routes.length) {
            // 绘制第一条路线，也可以按需求绘制其它几条路线
            if (routeLine === null) drawRoute(result.routes[0]);
            // log.success('绘制驾车路线完成')
            callback && callback();
          }
        } else {
          log.error('获取数据失败：' + result)
        }
      });
    }

    function drawRoute(route) {
      var path = parseRouteToPath(route);
      routeLine = new AMap.Polyline({
        path: path,
        isOutline: true,
        outlineColor: '#ffeeee',
        borderWeight: 2,
        strokeWeight: 5,
        strokeColor: '#0091ff',
        lineJoin: 'round'
      })

      // map.add(routeLine);
    }

    function showRoute() {
      if (routeLine) {
        map.add(routeLine);
      }
    }

    function hideRoute() {
      if (routeLine) {
        map.remove(routeLine)
      }
    }

    // 解析DrivingRoute对象，构造成AMap.Polyline的path参数需要的格式
    // DrivingResult对象结构参考文档 https://lbs.amap.com/api/javascript-api/reference/route-search#m_DriveRoute
    function parseRouteToPath(route) {
      var path = []

      for (var i = 0, l = route.steps.length; i < l; i++) {
        var step = route.steps[i]

        for (var j = 0, n = step.path.length; j < n; j++) {
          path.push(step.path[j])
        }
      }

      return path
    }
  // 打开高德App
  function drivingOnApp() {
    // 定位成功，则有路线信息，否则，直接打开目的地
    if(drivingResult) {
      driving.searchOnAMAP({
          origin: {
            lng: myPosition[0],
            Q: myPosition[0],
            lat: myPosition[1],
            P: myPosition[1]
          },
          destination: {
            lng: targetPosition[0],
            Q: targetPosition[0],
            lat: targetPosition[1],
            P: targetPosition[1]
          }
      });
    } else {
      endMarker.markOnAMAP({
        name: destName,
        position: endMarker.getPosition()
      })
    }
  }
</script>
</body>
</html>